<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Majority LAN ‚Äî –ò–≥—Ä–∞</title>
  <link rel="stylesheet" href="/static/app.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #1a1a2e; 
      font-family: 'Segoe UI', system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #eee;
      user-select: none;
      padding: 20px;
    }
    
    .game-container { 
      max-width: 1200px; 
      margin: 0 auto; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 30px; 
      justify-content: center;
      align-items: flex-start;
    }
    
    #board {
      display: grid; 
      gap: 3px; 
      padding: 12px;
      background: #16213e;
      border-radius: 12px;
      box-shadow: 0 0 40px #0d1117aa;
    }
    
    .cell {
      background: #0f3460;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.25s, transform 0.2s, box-shadow 0.3s;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .cell:hover:not(.p1):not(.p2):not(.p3):not(.p4):not(.p5) { 
      background: #1a4a7a; 
      transform: scale(1.08); 
    }
    
    /* Player Colors (1..5) */
    .cell.p1 { background: #4fc3f7; box-shadow: 0 0 12px #4fc3f766; cursor: default; }
    .cell.p2 { background: #ef5350; box-shadow: 0 0 12px #ef535066; cursor: default; }
    .cell.p3 { background: #10b981; box-shadow: 0 0 12px #10b98166; cursor: default; }
    .cell.p4 { background: #f59e0b; box-shadow: 0 0 12px #f59e0b66; cursor: default; }
    .cell.p5 { background: #8b5cf6; box-shadow: 0 0 12px #8b5cf666; cursor: default; }

    .cell.threatened::after {
      content: '!';
      position: absolute;
      font-size: 20px;
      font-weight: 900;
      color: white;
      text-shadow: 0 0 6px rgba(255,255,255,0.9), 0 0 12px rgba(255,255,255,0.4);
      pointer-events: none;
      line-height: 1;
    }

    .cell.vulnerable::after {
      content: ''; 
      position: absolute; 
      width: 14px; 
      height: 14px;
      border-radius: 50%; 
      background: white;
      box-shadow: 0 0 6px rgba(255,255,255,0.8);
      animation: dotPulse 0.3s infinite alternate;
    }
    
    @keyframes dotPulse {
      from { transform: scale(0.7); opacity: 0.6; }
      to   { transform: scale(1.1); opacity: 1; }
    }

    .cell.flip { animation: flipCell 0.35s ease; }
    @keyframes flipCell {
      0%   { transform: scale(1); }
      50%  { transform: scale(0.3) rotate(180deg); }
      100% { transform: scale(1) rotate(360deg); }
    }
    
    .cell.locked { pointer-events: none; }

    .sidebar { 
      min-width: 280px; 
      text-align: left;
      background: #16213e;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px #0d1117aa;
    }
    
    .player-card {
      padding: 12px; 
      margin-bottom: 10px;
      background: #0f3460; 
      border-radius: 8px; 
      border: 2px solid #1a4a7a;
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      transition: all 0.3s;
    }
    
    .player-card.active { 
      border-color: #4fc3f7; 
      background: #1a4a7a; 
      transform: scale(1.03);
      box-shadow: 0 0 12px #4fc3f766;
    }
    
    /* –î–µ–±–∞–≥ –º–æ–¥: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–µ–±–∞–≥-–∏–≥—Ä–æ–∫–∞ */
    .player-card.debug-active-player {
      border-color: #f59e0b;
      background: #2a2a0a;
      box-shadow: 0 0 12px #f59e0b66;
    }
    
    .dot { 
      width: 18px; 
      height: 18px; 
      border-radius: 50%; 
      display: inline-block; 
      margin-right: 10px;
    }
    
    .dot.p1 { background: #4fc3f7; box-shadow: 0 0 8px #4fc3f7aa; }
    .dot.p2 { background: #ef5350; box-shadow: 0 0 8px #ef5350aa; }
    .dot.p3 { background: #10b981; box-shadow: 0 0 8px #10b981aa; }
    .dot.p4 { background: #f59e0b; box-shadow: 0 0 8px #f59e0baa; }
    .dot.p5 { background: #8b5cf6; box-shadow: 0 0 8px #8b5cf6aa; }
    
    .status { 
      font-size: 1.3rem; 
      margin-bottom: 20px; 
      font-weight: bold; 
      color: #e0e0ff;
      text-align: center;
      padding: 12px;
      background: #0f3460;
      border-radius: 8px;
      letter-spacing: 1px;
    }
    
    .my-turn { 
      color: #4fc3f7; 
      animation: pulse 0.8s infinite alternate;
    }
    
    @keyframes pulse { 
      from { opacity: 0.7; } 
      to { opacity: 1; } 
    }
    
    .btn {
      padding: 10px 24px;
      border: 2px solid #e0e0ff44;
      background: transparent;
      color: #e0e0ff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
      width: 100%;
      margin-top: 12px;
    }
    
    .btn:hover {
      background: #e0e0ff15;
      border-color: #e0e0ffaa;
    }

    /* –õ–æ–≥–≥–µ—Ä —á–µ–∫–±–æ–∫—Å */
    .log-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border: 2px solid #e0e0ff44;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #e0e0ff;
      transition: all 0.2s;
      user-select: none;
      width: 100%;
      margin-top: 12px;
      box-sizing: border-box;
    }
    .log-toggle:hover { background: #e0e0ff15; border-color: #e0e0ffaa; }
    .log-toggle input[type=checkbox] { width: 16px; height: 16px; cursor: pointer; accent-color: #4fc3f7; }
    .log-toggle.log-active { border-color: #4fc3f7; background: #4fc3f711; color: #4fc3f7; }

    /* –î–µ–±–∞–≥ –ø–∞–Ω–µ–ª—å */
    #debug-panel {
      display: none;
      margin-top: 16px;
      padding: 12px;
      background: #1a2a0a;
      border: 2px solid #f59e0b66;
      border-radius: 8px;
    }
    #debug-panel.show { display: block; }
    #debug-panel h3 {
      color: #f59e0b;
      font-size: 0.9rem;
      margin-bottom: 10px;
      text-align: center;
      letter-spacing: 1px;
    }
    .debug-player-btn {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 6px;
      border: 2px solid #e0e0ff33;
      background: transparent;
      color: #e0e0ff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      text-align: left;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .debug-player-btn:hover { background: #e0e0ff10; border-color: #e0e0ff66; }
    .debug-player-btn.selected {
      border-color: #f59e0b;
      background: #f59e0b22;
      color: #f59e0b;
    }
    
    #winner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10,10,30,0.88);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 100;
    }
    
    #winner-overlay.show { display: flex; }
    #winner-overlay h2 { 
      font-size: 2.5rem; 
      margin-bottom: 20px; 
      color: #e0e0ff;
      text-shadow: 0 0 20px rgba(224, 224, 255, 0.5);
    }
    
    #winner-overlay .btn { 
      font-size: 1.1rem; 
      padding: 14px 40px;
      width: auto;
    }
    .winner-btns { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–µ–±–∞–≥-—Ä–µ–∂–∏–º–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ */
    .debug-badge {
      display: none;
      background: #f59e0b;
      color: #1a1a2e;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 10px;
      letter-spacing: 1px;
      margin-left: 8px;
    }
    .debug-badge.show { display: inline-block; }
  </style>
</head>
<body>

<div id="code" hidden>{{ code }}</div>

<div class="game-container">
  <div id="board"></div>

  <div class="sidebar">
    <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...<span class="debug-badge" id="debugBadge">DEBUG</span></div>
    <div id="players-list"></div>

    <!-- –î–µ–±–∞–≥-–ø–∞–Ω–µ–ª—å: –≤—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞ -->
    <div id="debug-panel">
      <h3>üîß DEBUG: –•–æ–¥–∏—Ç –∑–∞</h3>
      <div id="debug-player-buttons"></div>
    </div>

    <!-- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <label class="log-toggle" id="logToggleLabel">
      <input type="checkbox" id="logCheckbox" onchange="toggleLogging()" />
      üìù –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É
    </label>

    <button class="btn" onclick="location.href='/'">&#8592; –í—ã—Ö–æ–¥ –≤ –º–µ–Ω—é</button>
  </div>
</div>

<div id="winner-overlay">
  <h2 id="winner-text"></h2>
  <div class="winner-btns">
    <button class="btn" onclick="location.href='/'">&#9654; –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    <button class="btn" id="btnSaveLog" onclick="GameLogger.save()" style="display:none;">&#128190; –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥</button>
  </div>
</div>

<!-- –û–±—â–∏–µ –º–æ–¥—É–ª–∏ -->
<script src="/static/game-logic.js"></script>
<script src="/static/game-logger.js"></script>

<script>
const code = document.getElementById('code').textContent.trim();
const myId = localStorage.getItem('mg_player_id');

// =============================================
// DEBUG-LOCAL MODE
// –ï—Å–ª–∏ –≤ localStorage –µ—Å—Ç—å 'mg_debug_local' = '1',
// —Ç–æ –≤–∫–ª—é—á–∞–µ–º—Å—è —Ä–µ–∂–∏–º –ø–æ–ª–Ω–æ–π —ç–º—É–ª—è—Ü–∏–∏.
// –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –≤—Å–µ API-–∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Ç–∞–∫ –∂–µ –∫–∞–∫ –æ–±—ã—á–Ω–æ,
// –Ω–æ player_id –º–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.
// =============================================
const isDebugLocal = localStorage.getItem('mg_debug_local') === '1';

// –¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫ –≤ –¥–µ–±–∞–≥-—Ä–µ–∂–∏–º–µ (–∏–Ω–¥–µ–∫—Å 0-based)
let debugCurrentPlayerIdx = 0;
let debugPlayersInfo = [];  // –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ refresh()

let boardSize = 8;
let currentBoard = [];
let playersInfo = [];
let animationInProgress = false;
let lastBoardState = '';
let loggingEnabled = false;
let loggerInitialized = false;

// =============================================
// DEBUG PANEL
// =============================================
function initDebugPanel() {
  if (!isDebugLocal) return;
  document.getElementById('debug-panel').classList.add('show');
  document.getElementById('debugBadge').classList.add('show');
}

function renderDebugPanel(info) {
  if (!isDebugLocal || !info || info.length === 0) return;
  debugPlayersInfo = info;
  const container = document.getElementById('debug-player-buttons');
  container.innerHTML = info.map((p, i) => {
    const pNum = i + 1;
    const isSelected = i === debugCurrentPlayerIdx;
    return `<button class="debug-player-btn ${isSelected ? 'selected' : ''}" onclick="selectDebugPlayer(${i})">
      <span class="dot p${pNum}" style="width:14px;height:14px;margin-right:6px;"></span>
      P${pNum}: ${p.nick}
      ${isSelected ? ' (–•–æ–∂—É)' : ''}
    </button>`;
  }).join('');
}

function selectDebugPlayer(idx) {
  debugCurrentPlayerIdx = idx;
  renderDebugPanel(debugPlayersInfo);
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π player_id: –≤ –¥–µ–±–∞–≥–µ ‚Äî –∏–¥ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –∏–Ω–∞—á–µ ‚Äî myId
function getActivePlayerId() {
  if (isDebugLocal && debugPlayersInfo.length > 0) {
    return debugPlayersInfo[debugCurrentPlayerIdx].id;
  }
  return myId;
}

// =============================================
// LOGGING
// =============================================
function toggleLogging() {
  loggingEnabled = document.getElementById('logCheckbox').checked;
  const label = document.getElementById('logToggleLabel');
  label.classList.toggle('log-active', loggingEnabled);
}

function _maybeInitLogger(info) {
  if (!loggingEnabled || loggerInitialized) return;
  const playerNames = {};
  (info || []).forEach((p, i) => { playerNames[i + 1] = p.nick; });
  GameLogger.init({
    enabled: true,
    mode: isDebugLocal ? 'debug-local' : 'multiplayer',
    boardSize: boardSize,
    playerNames
  });
  loggerInitialized = true;
}

// =============================================
// ORIGINAL MULTIPLAYER CODE (unchanged API logic)
// =============================================
async function api(path, body){
    const opts = body ? { 
      method:'POST', 
      body: JSON.stringify(body), 
      headers: {'Content-Type':'application/json'} 
    } : {};
    return fetch(path, opts).then(r=>r.json());
}

function cellSize(size) { 
  return size <= 10 ? 56 : 32; 
}

function getCell(r, c) {
  const el = document.getElementById('board');
  if (!el) return null;
  return el.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
}

function updateThreatsMultiplayer() {
  if (!currentBoard || currentBoard.length === 0) return;
  
  const N = currentBoard.length;
  
  for (let r = 0; r < N; r++) {
    for (let c = 0; c < N; c++) {
      const cell = getCell(r, c);
      if (!cell) continue;
      
      const player = currentBoard[r][c];
      if (player === 0) {
        cell.classList.remove('threatened');
        continue;
      }
      
      const fn = countAround(currentBoard, r, c, player);
      let maxEnemyCount = 0;
      for (let p = 1; p <= 5; p++) {
        if (p !== player) {
          const en = countAround(currentBoard, r, c, p);
          maxEnemyCount = Math.max(maxEnemyCount, en);
        }
      }
      
      const hasEmpty = neighbors(r, c, N)
        .some(([rr,cc]) => currentBoard[rr][cc] === 0);
      
      const threatened = (fn - maxEnemyCount < 1) && hasEmpty;
      cell.classList.toggle('threatened', threatened);
    }
  }
}

function updateCellVisual(r, c, animate) {
  const cell = getCell(r, c);
  if (!cell) return;
  
  const val = currentBoard[r][c];
  const cls = val > 0 ? ` p${val}` : '';
  cell.className = 'cell' + cls;
  
  if (animate) {
    cell.classList.add('flip');
    setTimeout(() => cell.classList.remove('flip'), 350);
  }
}

function calculateCascadeWavesMultiplayer(initialBoard, moveR, moveC, player) {
  const N = initialBoard.length;
  const waves = [];
  const tmp = initialBoard.map(row => [...row]);
  
  tmp[moveR][moveC] = player;
  
  let go = true;
  while (go) {
    go = false;
    const wave = [];
    
    for (let rr = 0; rr < N; rr++) {
      for (let cc = 0; cc < N; cc++) {
        const cellVal = tmp[rr][cc];
        if (cellVal !== 0 && cellVal !== player) {
          const friendlyCount = countAround(tmp, rr, cc, player);
          const enemyCount = countAround(tmp, rr, cc, cellVal);
          
          if (friendlyCount > enemyCount) {
            wave.push([rr, cc]);
          }
        }
      }
    }
    
    if (wave.length > 0) {
      wave.forEach(([r, c]) => {
        tmp[r][c] = player;
      });
      waves.push(wave);
      go = true;
    }
  }
  
  return waves;
}

function renderBoardWithAnimation(newBoard, oldBoard) {
  const N = newBoard.length;
  
  let moveR = -1, moveC = -1, player = 0;
  for (let r = 0; r < N; r++) {
    for (let c = 0; c < N; c++) {
      if (oldBoard[r][c] === 0 && newBoard[r][c] !== 0) {
        moveR = r;
        moveC = c;
        player = newBoard[r][c];
        break;
      }
    }
    if (moveR >= 0) break;
  }
  
  if (moveR < 0) return 0;
  
  const waves = calculateCascadeWavesMultiplayer(oldBoard, moveR, moveC, player);

  // –õ–æ–≥–∏—Ä—É–µ–º —Ö–æ–¥ –∏ –∫–∞—Å–∫–∞–¥—ã
  if (GameLogger.isEnabled()) {
    GameLogger.logMove({ playerNum: player, r: moveR, c: moveC, boardBefore: oldBoard });
    waves.forEach((wave, idx) => {
      GameLogger.logCascade({ waveIndex: idx, cells: wave, playerNum: player });
    });
    const totalCaptured = waves.reduce((acc, w) => acc + w.length, 0);
    // –°—á—ë—Ç –ø–æ—Å–ª–µ —Ö–æ–¥–∞ –∑–∞–ø–∏—à–µ–º –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –≤–æ–ª–Ω
    setTimeout(() => {
      GameLogger.logMoveResult({ totalCaptured, boardAfter: currentBoard.map(r => [...r]) });
    }, waves.length * 700 + 500);
  }

  const DOT_TIME = 400;
  const FLIP_GAP = N <= 10 ? 150 : 80;
  const WAVE_PAUSE = 250;
  
  let t = 0;
  
  currentBoard[moveR][moveC] = player;
  updateCellVisual(moveR, moveC, false);
  updateThreatsMultiplayer();
  
  waves.forEach((wave) => {
    setTimeout(() => {
      wave.forEach(([r, c]) => {
        const cell = getCell(r, c);
        if (cell) {
          cell.classList.remove('threatened');
          cell.classList.add('vulnerable');
        }
      });
    }, t);
    t += DOT_TIME;
    
    wave.forEach(([r, c], i) => {
      setTimeout(() => {
        currentBoard[r][c] = player;
        const cell = getCell(r, c);
        if (cell) cell.classList.remove('vulnerable');
        updateCellVisual(r, c, true);
        updateThreatsMultiplayer();
      }, t + i * FLIP_GAP);
    });
    
    t += wave.length * FLIP_GAP + WAVE_PAUSE;
  });
  
  return t;
}

function renderBoard(grid, size) {
    const el = document.getElementById('board');
    const sz = cellSize(size);
    
    if(el.children.length !== size*size) {
        el.innerHTML = '';
        el.style.gridTemplateColumns = `repeat(${size}, ${sz}px)`;
        el.style.gap = size <= 10 ? '3px' : '2px';
        el.style.padding = size <= 10 ? '12px' : '8px';
        
        for(let r=0; r<size; r++){
            for(let c=0; c<size; c++){
                const d = document.createElement('div');
                d.className = 'cell';
                d.style.width = sz+'px';
                d.style.height = sz+'px';
                if (sz <= 32) d.style.fontSize = '14px';
                d.onclick = () => onCellClick(r,c);
                d.dataset.r = r;
                d.dataset.c = c;
                el.appendChild(d);
            }
        }
    }
    
    const boardStateStr = JSON.stringify(grid);
    const oldBoard = currentBoard.length === size ? currentBoard.map(row => [...row]) : grid.map(row => [...row]);
    
    if (boardStateStr !== lastBoardState && currentBoard.length === size) {
      const animTime = renderBoardWithAnimation(grid, oldBoard);
      if (animTime > 0) {
        animationInProgress = true;
        setTimeout(() => {
          animationInProgress = false;
          currentBoard = grid.map(row => [...row]);
        }, animTime);
      }
    } else {
      currentBoard = grid.map(row => [...row]);
      for(let r=0; r<size; r++){
        for(let c=0; c<size; c++){
          updateCellVisual(r, c, false);
        }
      }
      updateThreatsMultiplayer();
    }
    
    lastBoardState = boardStateStr;
}

async function onCellClick(r, c) {
    if (animationInProgress) return;

    // –í –¥–µ–±–∞–≥-—Ä–µ–∂–∏–º–µ —à–ª—ë–º –æ—Ç –∏–º–µ–Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    const activeId = getActivePlayerId();
    
    const res = await api(`/api/game/${code}/move`, {player_id: activeId, r, c});
    if(res.ok) {
        document.querySelectorAll('.cell').forEach(cell => {
          cell.classList.add('locked');
        });

        // –î–µ–±–∞–≥: –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ö–æ–¥–∞ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
        if (isDebugLocal && debugPlayersInfo.length > 0) {
          // –ò—â–µ–º —Ç–æ–≥–æ, —á—å—è –æ—á–µ—Ä–µ–¥—å –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π (–ø–æ–ª—É—á–∏–º –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ refresh)
          setTimeout(() => {
            refresh().then((data) => {
              if (data && data.current_player_id) {
                const nextIdx = debugPlayersInfo.findIndex(p => p.id === data.current_player_id);
                if (nextIdx >= 0) {
                  debugCurrentPlayerIdx = nextIdx;
                  renderDebugPanel(debugPlayersInfo);
                }
              }
              setTimeout(() => {
                document.querySelectorAll('.cell').forEach(cell => {
                  cell.classList.remove('locked');
                });
              }, 500);
            });
          }, 100);
        } else {
          setTimeout(() => {
            refresh().then(() => {
              setTimeout(() => {
                document.querySelectorAll('.cell').forEach(cell => {
                  cell.classList.remove('locked');
                });
              }, 500);
            });
          }, 100);
        }
    } else {
        console.log('Move error:', res.error);
    }
}

function renderPlayers(info, scores, currentId, winner) {
    playersInfo = info;
    const box = document.getElementById('players-list');
    box.innerHTML = info.map((p, i) => {
        const pNum = i + 1;
        const isTurn = p.id === currentId;
        // –í –¥–µ–±–∞–≥–µ: –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–æ–≥–æ —á—å—è –æ—á–µ—Ä–µ–¥—å
        const isDebugSelected = isDebugLocal && i === debugCurrentPlayerIdx;
        const isMe = !isDebugLocal && p.id === myId;
        const score = scores[p.id] || 0;
        return `
            <div class="player-card ${isTurn ? 'active' : ''} ${isDebugSelected ? 'debug-active-player' : ''}">
                <div style="display:flex;align-items:center">
                    <span class="dot p${pNum}"></span>
                    <b>${p.nick}</b> ${isMe ? '(–í—ã)' : ''} ${isDebugSelected ? '(–•–æ–∂—É)' : ''}
                </div>
                <div style="font-size:1.3em; font-weight:bold">${score}</div>
            </div>
        `;
    }).join('');

    const status = document.getElementById('status');
    if(winner && !animationInProgress) {
        status.textContent = "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!";
        status.className = "status";
        const badge = document.getElementById('debugBadge');
        if (badge && isDebugLocal) badge.classList.add('show');
        
        // –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã
        if (GameLogger.isEnabled()) {
          const finalScores = {};
          info.forEach((p, i) => { finalScores[i + 1] = scores[p.id] || 0; });
          let winnerNum = null;
          if (winner !== 'draw') {
            const wIdx = info.findIndex(x => x.id === winner);
            if (wIdx >= 0) winnerNum = wIdx + 1;
          }
          GameLogger.logGameEnd({
            winner,
            playerNum: winnerNum,
            scores: finalScores,
            reason: '–¥–æ—Å–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –ø–æ–±–µ–¥–∞ –ø–æ –æ—á–∫–∞–º'
          });
          const btnSave = document.getElementById('btnSaveLog');
          if (btnSave) btnSave.style.display = 'inline-block';
        }
        
        const wInfo = info.find(x=>x.id === winner);
        let wText = '';
        
        if (winner === 'draw') {
          wText = 'ü§ù –ù–∏—á—å—è!';
        } else if (wInfo) {
          const wNum = info.indexOf(wInfo) + 1;
          const colors = ['üîµ', 'üî¥', 'üü¢', 'üü°', 'üü£'];
          const emoji = colors[wNum - 1] || '‚≠ê';
          const score = scores[winner] || 0;
          wText = `${emoji} ${wInfo.nick} –ø–æ–±–µ–¥–∏–ª! (${score} –∫–ª–µ—Ç–æ–∫)`;
        } else {
          wText = 'üéÆ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!';
        }
        
        document.getElementById('winner-text').textContent = wText;
        document.getElementById('winner-overlay').classList.add('show');
    } else {
        const badge = document.getElementById('debugBadge');

        if (isDebugLocal) {
          // –î–µ–±–∞–≥: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –æ—á–µ—Ä–µ–¥—å —Å–µ—Ä–≤–µ—Ä–∞ + –∫—Ç–æ —è —Å–µ–π—á–∞—Å —Ö–æ–∂—É
          const curTurn = info.find(x => x.id === currentId);
          const myTurn = debugPlayersInfo.length > 0 ? debugPlayersInfo[debugCurrentPlayerIdx] : null;
          const serverTurn = curTurn ? curTurn.nick : '...';
          const myDebugNick = myTurn ? myTurn.nick : '?';
          status.innerHTML = `–û—á–µ—Ä–µ–¥—å: <b>${serverTurn}</b><br><small style="color:#f59e0b">–ö–ª–∏–∫–∞—é –∑–∞: ${myDebugNick}</small><span class="debug-badge show" style="margin-left:6px;">DEBUG</span>`;
          status.className = "status";
        } else if(currentId === myId) {
            status.textContent = "‚ö° –í–ê–® –•–û–î";
            status.className = "status my-turn";
        } else {
            const cur = info.find(x=>x.id === currentId);
            status.textContent = "–•–æ–¥–∏—Ç " + (cur ? cur.nick : "...");
            status.className = "status";
        }
    }
}

async function refresh() {
    try {
        // –í –¥–µ–±–∞–≥ —Ä–µ–∂–∏–º–µ: –ø–æ–ª—å–∑—É–µ–º—Å—è myId –¥–ª—è –ø–∏–Ω–≥–∞ (–Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–æ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Ç–∞–∫–∂–µ –ø–∏–Ω–≥—É–µ—Ç)
        const data = await api(`/api/game/${code}?player_id=${myId}`);
        if(data.error) {
          console.error('Game error:', data.error);
          return null;
        }

        boardSize = data.size;
        renderBoard(data.board, data.size);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–≥–µ—Ä –ø—Ä–∏ –ø–µ—Ä–≤–æ–º refresh –µ—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
        if (loggingEnabled && !loggerInitialized) {
          _maybeInitLogger(data.players_info);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ–±–∞–≥-–ø–∞–Ω–µ–ª—å –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ
        if (isDebugLocal) {
          renderDebugPanel(data.players_info);
        }

        if (data.winner && !animationInProgress) {
          setTimeout(() => {
            renderPlayers(data.players_info, data.scores, data.current_player_id, data.winner);
          }, 200);
        } else {
          renderPlayers(data.players_info, data.scores, data.current_player_id, data.winner);
        }

        return data;
    } catch (e) {
        console.error('Refresh error:', e);
        return null;
    }
}

initDebugPanel();
setInterval(refresh, 1000);
refresh();

</script>
</body>
</html>
