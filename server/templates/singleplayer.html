<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Majority ‚Äî –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è</title>
<link rel="stylesheet" href="/static/app.css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #1a1a2e;
    font-family: 'Segoe UI', system-ui, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    color: #eee;
    user-select: none;
  }
  h1 { font-size: 1.6rem; margin-bottom: 8px; letter-spacing: 2px; color: #e0e0ff; text-transform: uppercase; }
  .info-bar { display: flex; gap: 32px; align-items: center; margin-bottom: 12px; font-size: 1.05rem; }
  .score { display: flex; align-items: center; gap: 8px; font-weight: 600; }
  .score .dot { width: 18px; height: 18px; border-radius: 50%; display: inline-block; }
  .dot.p1 { background: #4fc3f7; box-shadow: 0 0 8px #4fc3f7aa; }
  .dot.p2 { background: #ef5350; box-shadow: 0 0 8px #ef5350aa; }
  .turn-label {
    padding: 4px 16px; border-radius: 20px; font-weight: 700;
    font-size: 0.95rem; transition: all 0.3s;
  }
  .turn-label.p1 { background: #4fc3f733; border: 2px solid #4fc3f7; color: #4fc3f7; }
  .turn-label.p2 { background: #ef535033; border: 2px solid #ef5350; color: #ef5350; }

  #board {
    display: grid; gap: 3px; padding: 12px;
    background: #16213e; border-radius: 12px;
    box-shadow: 0 0 40px #0d1117aa;
  }
  .cell {
    background: #0f3460; border-radius: 6px;
    cursor: pointer; transition: background 0.25s, transform 0.2s, box-shadow 0.3s;
    position: relative; display: flex; align-items: center; justify-content: center;
  }
  .cell:hover:not(.p1):not(.p2) { background: #1a4a7a; transform: scale(1.08); }
  .cell.p1 { background: #4fc3f7; box-shadow: 0 0 12px #4fc3f766; cursor: default; }
  .cell.p2 { background: #ef5350; box-shadow: 0 0 12px #ef535066; cursor: default; }

  .cell.threatened::after {
    content: '!';
    position: absolute;
    font-size: 20px;
    font-weight: 900;
    color: white;
    text-shadow: 0 0 6px rgba(255,255,255,0.9), 0 0 12px rgba(255,255,255,0.4);
    pointer-events: none;
    line-height: 1;
  }

  .cell.vulnerable::after {
    content: ''; position: absolute; width: 14px; height: 14px;
    border-radius: 50%; background: white;
    box-shadow: 0 0 6px rgba(255,255,255,0.8);
    animation: dotPulse 0.3s infinite alternate;
  }
  @keyframes dotPulse {
    from { transform: scale(0.7); opacity: 0.6; }
    to   { transform: scale(1.1); opacity: 1; }
  }

  .cell.flip { animation: flipCell 0.35s ease; }
  @keyframes flipCell {
    0%   { transform: scale(1); }
    50%  { transform: scale(0.3) rotate(180deg); }
    100% { transform: scale(1) rotate(360deg); }
  }
  .cell.locked { pointer-events: none; }

  .controls { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
  .btn {
    padding: 8px 20px; border: 2px solid #e0e0ff44; background: transparent;
    color: #e0e0ff; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
  }
  .btn:hover { background: #e0e0ff15; border-color: #e0e0ffaa; }
  .btn.active { background: #e0e0ff22; border-color: #e0e0ff; }

  /* –õ–æ–≥–≥–µ—Ä —á–µ–∫–±–æ–∫—Å */
  .log-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 2px solid #e0e0ff44;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    color: #e0e0ff;
    transition: all 0.2s;
    user-select: none;
  }
  .log-toggle:hover { background: #e0e0ff15; border-color: #e0e0ffaa; }
  .log-toggle input[type=checkbox] { width: 16px; height: 16px; cursor: pointer; accent-color: #4fc3f7; }
  .log-toggle.log-active { border-color: #4fc3f7; background: #4fc3f711; color: #4fc3f7; }

  .rules {
    margin-top: 14px; max-width: 520px; text-align: center;
    font-size: 0.8rem; color: #8888aa; line-height: 1.5;
  }

  #winner-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(10,10,30,0.88); align-items: center; justify-content: center;
    flex-direction: column; z-index: 100;
  }
  #winner-overlay.show { display: flex; }
  #winner-overlay h2 { font-size: 2rem; margin-bottom: 16px; }
  #winner-overlay .btn { font-size: 1.1rem; padding: 12px 36px; }
  .winner-btns { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }

  .thinking { opacity: 0.7; animation: pulse 0.8s infinite alternate; }
  @keyframes pulse { from { opacity: 0.5; } to { opacity: 1; } }
</style>
</head>
<body>

<h1>‚ö° MAJORITY</h1>

<div class="info-bar">
  <div class="score"><span class="dot p1"></span> –í—ã: <span id="score1">0</span></div>
  <div class="turn-label p1" id="turnLabel">–í–∞—à —Ö–æ–¥</div>
  <div class="score"><span class="dot p2"></span> –ò–ò: <span id="score2">0</span></div>
</div>

<div id="board"></div>

<div class="controls">
  <button class="btn" onclick="location.href='/'">&#8592; –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
  <button class="btn" onclick="initGame()">‚ü≥ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
  <button class="btn" onclick="toggleSize()">–ü–æ–ª–µ: <span id="sizeLabel">8√ó8</span></button>
  <button class="btn" onclick="toggleDifficulty()" id="diffBtn">–ò–ò: –°—Ä–µ–¥–Ω–∏–π</button>
  <button class="btn" onclick="toggleCascade()">–ö–∞—Å–∫–∞–¥: <span id="cascLabel">–í–ö–õ</span></button>
  <label class="log-toggle" id="logToggleLabel">
    <input type="checkbox" id="logCheckbox" onchange="toggleLogging()" />
    üìù –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É
  </label>
</div>

<div class="rules">
  –°—Ç–∞–≤—å—Ç–µ —Ñ–∏—à–∫—É –Ω–∞ –ø—É—Å—Ç—É—é –∫–ª–µ—Ç–∫—É. –í—Ä–∞–∂–µ—Å–∫–∞—è –∫–ª–µ—Ç–∫–∞ <b>–∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è</b>,
  –µ—Å–ª–∏ —Å—Ä–µ–¥–∏ –µ—ë 8 —Å–æ—Å–µ–¥–µ–π –≤–∞—à–∏—Ö —Ñ–∏—à–µ–∫ <b>—Å—Ç—Ä–æ–≥–æ –±–æ–ª—å—à–µ</b>, —á–µ–º –≤—Ä–∞–∂–µ—Å–∫–∏—Ö. –ö–∞—Å–∫–∞–¥ ‚Äî –∑–∞—Ö–≤–∞—Ç—ã –ø–æ—Ä–æ–∂–¥–∞—é—Ç –Ω–æ–≤—ã–µ.
</div>

<div id="winner-overlay">
  <h2 id="winnerText"></h2>
  <div class="winner-btns">
    <button class="btn" onclick="initGame(); document.getElementById('winner-overlay').classList.remove('show');">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    <button class="btn" id="btnSaveLog" onclick="GameLogger.save()" style="display:none;">&#128190; –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥</button>
  </div>
</div>

<!-- –û–±—â–∏–µ –º–æ–¥—É–ª–∏ -->
<script src="/static/game-logic.js"></script>
<script src="/static/animations.js"></script>
<script src="/static/ai.js"></script>
<script src="/static/game-logger.js"></script>

<script>
// ==== Game State ====
const SIZES = [6, 8, 10, 16];
const DIFF_NAMES = ['–õ—ë–≥–∫–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–°–ª–æ–∂–Ω—ã–π'];
let sizeIdx = 1, N = 8;
let diffIdx = 1;
let board = [], currentPlayer = 1, cascadeOn = true, gameOver = false, aiThinking = false;
let loggingEnabled = false;

function toggleSize() { 
  sizeIdx = (sizeIdx+1)%SIZES.length; 
  N = SIZES[sizeIdx]; 
  document.getElementById('sizeLabel').textContent = N+'√ó'+N; 
  initGame(); 
}

function toggleCascade() { 
  cascadeOn = !cascadeOn; 
  document.getElementById('cascLabel').textContent = cascadeOn ? '–í–ö–õ' : '–í–´–ö–õ'; 
}

function toggleDifficulty() { 
  diffIdx = (diffIdx+1)%3; 
  document.getElementById('diffBtn').textContent = '–ò–ò: '+DIFF_NAMES[diffIdx]; 
  initGame(); 
}

function toggleLogging() {
  loggingEnabled = document.getElementById('logCheckbox').checked;
  const label = document.getElementById('logToggleLabel');
  label.classList.toggle('log-active', loggingEnabled);
  // –ï—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –∏–≥—Ä—ã ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
  if (loggingEnabled && !gameOver) {
    // –ü—Ä–æ—Å—Ç–æ –æ—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–Ω—ë—Ç—Å—è —Å–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥–∞
    GameLogger.init({
      enabled: true,
      mode: 'singleplayer',
      boardSize: N,
      playerNames: { 1: '–ò–≥—Ä–æ–∫', 2: '–ò–ò (' + DIFF_NAMES[diffIdx] + ')' }
    });
  }
}

function _initLogger() {
  GameLogger.init({
    enabled: loggingEnabled,
    mode: 'singleplayer',
    boardSize: N,
    playerNames: { 1: '–ò–≥—Ä–æ–∫', 2: '–ò–ò (' + DIFF_NAMES[diffIdx] + ')' }
  });
}

function initGame() {
  board = Array.from({length:N}, ()=>Array(N).fill(0));
  currentPlayer = 1; gameOver = false; aiThinking = false;
  renderBoard(N);
  attachClickHandlers();
  updateInfo();
  _initLogger();
}

function attachClickHandlers() {
  document.querySelectorAll('.cell').forEach(cell => {
    const r = parseInt(cell.dataset.r);
    const c = parseInt(cell.dataset.c);
    cell.addEventListener('click', () => onCellClick(r, c));
  });
}

function onCellClick(r, c) {
  if (gameOver || aiThinking || currentPlayer!==1 || board[r][c]!==0) return;
  const legal = getLegalCells(board, 1);
  if (!legal.some(([lr,lc]) => lr===r && lc===c)) return;

  // –õ–æ–≥–∏—Ä—É–µ–º —Ö–æ–¥
  GameLogger.logMove({ playerNum: 1, r, c, boardBefore: board.map(row => [...row]) });

  lockBoard(true);
  const waves = cascadeOn ? calculateCascadeWaves(board, r, c, 1, true) : [];
  const animTime = applyMoveWithAnimation(board, r, c, 1, cascadeOn);

  // –õ–æ–≥–∏—Ä—É–µ–º –≤–æ–ª–Ω—ã –∫–∞—Å–∫–∞–¥–∞
  waves.forEach((wave, idx) => {
    GameLogger.logCascade({ waveIndex: idx, cells: wave, playerNum: 1 });
  });
  const totalCaptured = waves.reduce((acc, w) => acc + w.length, 0);

  setTimeout(() => {
    GameLogger.logMoveResult({ totalCaptured, boardAfter: board.map(row => [...row]) });
    currentPlayer = 2;
    updateInfo();
    if (checkEnd()) { lockBoard(false); return; }
    aiThinking = true;
    updateInfo();
    const delay = Math.max(300, 50 * N);
    setTimeout(() => { makeAIMove(); }, delay);
  }, animTime);
}

function makeAIMove() {
  // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –¥–æ—Å–∫—É –¥–æ —Ö–æ–¥–∞ (–¥–ª—è –ª–æ–≥–∞)
  const boardBeforeAI = board.map(row => [...row]);

  aiMove(board, diffIdx, cascadeOn, (animTime, aiR, aiC) => {
    // –õ–æ–≥–∏—Ä—É–µ–º —Ö–æ–¥ –ò–ò
    if (aiR !== undefined && aiC !== undefined) {
      GameLogger.logMove({ playerNum: 2, r: aiR, c: aiC, boardBefore: boardBeforeAI });
      const aiWaves = cascadeOn ? calculateCascadeWaves(boardBeforeAI, aiR, aiC, 2, true) : [];
      aiWaves.forEach((wave, idx) => {
        GameLogger.logCascade({ waveIndex: idx, cells: wave, playerNum: 2 });
      });
      const aiCaptured = aiWaves.reduce((acc, w) => acc + w.length, 0);
      GameLogger.logMoveResult({ totalCaptured: aiCaptured, boardAfter: board.map(row => [...row]) });
    }

    setTimeout(() => {
      currentPlayer = 1;
      aiThinking = false;
      lockBoard(false);
      updateInfo();
      checkEnd();
    }, animTime || 0);
  });
}

function updateInfo() {
  let s1=0, s2=0;
  board.forEach(row=>row.forEach(v=>{ if(v===1)s1++; if(v===2)s2++; }));
  document.getElementById('score1').textContent = s1;
  document.getElementById('score2').textContent = s2;
  const label = document.getElementById('turnLabel');
  if (aiThinking) {
    label.className = 'turn-label p2 thinking';
    label.textContent = '–ò–ò –¥—É–º–∞–µ—Ç...';
  } else {
    label.className = 'turn-label ' + (currentPlayer===1?'p1':'p2');
    label.textContent = currentPlayer===1 ? '–í–∞—à —Ö–æ–¥' : '–•–æ–¥ –ò–ò';
  }
}

function checkEnd() {
  let s1=0, s2=0, empty=0;
  board.forEach(row=>row.forEach(v=>{ if(v===1)s1++; if(v===2)s2++; if(v===0)empty++; }));

  const totalPlaced = s1 + s2;
  let ended = false;

  if (totalPlaced >= 2 && (s1 === 0 || s2 === 0)) ended = true;
  if (empty === 0) ended = true;

  if (ended) {
    gameOver = true;

    let winnerNum = null;
    let winnerLabel = 'draw';
    if (s1 > s2) winnerNum = 1;
    else if (s2 > s1) winnerNum = 2;

    GameLogger.logGameEnd({
      winner: winnerLabel,
      playerNum: winnerNum,
      scores: { 1: s1, 2: s2 },
      reason: empty === 0 ? '–¥–æ—Å–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞' : '–ø–æ–±–µ–¥–∞ –ø–æ –æ—á–∫–∞–º'
    });

    const overlay = document.getElementById('winner-overlay');
    const txt = document.getElementById('winnerText');
    if (s1 > s2) { txt.textContent = 'üîµ –í—ã –ø–æ–±–µ–¥–∏–ª–∏! '+s1+' ‚Äî '+s2; txt.style.color='#4fc3f7'; }
    else if (s2 > s1) { txt.textContent = 'üî¥ –ò–ò –ø–æ–±–µ–¥–∏–ª! '+s2+' ‚Äî '+s1; txt.style.color='#ef5350'; }
    else { txt.textContent = 'ü§ù –ù–∏—á—å—è! '+s1+' ‚Äî '+s2; txt.style.color='#e0e0ff'; }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–∞
    const btnSave = document.getElementById('btnSaveLog');
    if (btnSave) btnSave.style.display = GameLogger.isEnabled() ? 'inline-block' : 'none';

    overlay.classList.add('show');
    return true;
  }
  return false;
}

initGame();
</script>
</body>
</html>
